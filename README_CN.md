# Lumina Studio

基于物理校准的多材料FDM色彩系统

[📖 English Version / 英文文档](README.md)

---

## 项目状态

**当前版本**: v1.5.6  
**协议**: CC BY-NC-SA 4.0（附商业豁免条款）  
**性质**: 非营利性独立实现，开源社区项目

---

## 灵感来源与技术声明

### 致谢先驱者

本项目的存在离不开以下技术的公开与分享：

- **HueForge** - 首个将光学混色引入FDM社区的工具，证明了透明耗材分层叠加可通过光传递实现丰富色彩。
- **AutoForge** - 自动化色彩匹配工作流，让多材料彩色打印变得易用。
- **CMYK印刷理论** - 经典减色模型在3D打印中的逐层透射改编。

### 技术区别与定位

传统工具依赖理论计算（如TD1/TD0透射距离值），但这些参数极易因各种客观原因差异而失效。

**Lumina Studio采用"穷举法"路线**：
1. 打印1024色物理校准板（4色×5层的全排列）
2. 拍照扫描，提取真实RGB数据
3. 建立"实际测试查找表"（LUT）
4. 用最近邻算法匹配（类似于Bambulab的钥匙扣生成器的匹配）


### 现有技术（Prior Art）声明

FDM多层叠色的核心原理已于2022-2023年间由HueForge等软件公开披露，属于**现有技术**（Prior Art）。
Hueforge作者也明确，此类技术原理已经进入公共领域，在绝大部分国家和地区，如果专利局认真审核，原理性专利一定会被驳回。
先驱者选择保持开放以帮助社区发展，因此该技术通常**不具备专利性**。

Lumina Studio一直将以开源，互助，非盈利性的定位保持下去，欢迎各位监督。
- 本项目为开源非盈利项目，不会进行任何捆绑销售，并且不会将任何功能做成付费功能。
- 如果你或你的企业希望支持项目持续发展，欢迎联系。赞助的产品等将仅用于软件的开发和测试优化。
- 赞助仅代表对项目的支持，赞助行为不构成任何商业绑定。
- 拒绝任何影响技术决策或开源协议的赞助合作。
Lumina Stuido并未参考任何申请的专利内容，因为该类专利大部分情况下只有说明书，并且短期内不会公开技术代码，盲目参考这些专利，会影响自身开发的思路。
**特别感谢HueForge团队对开源的支持和理解！**

---

## 生态开放

### 关于 .npy 校准文件

所有校准预设（`.npy`文件）**完全免费开放**，遵循以下原则：

- **拒绝供应商锁定**：过去、现在、未来，我们**永远不会**强迫用户使用特定耗材品牌，也不会要求制造商生产符合要求的特定的"兼容耗材"。这违背开源精神。
  
- **社区共建**：欢迎所有用户、组织、耗材厂商提交PR，同步校准预设。你的打印机数据可以帮助他人。
- 无需任何其他测试工具，只需要你有3D打印机和手机。

**数据开放 = 技术民主化**

---

## 许可协议

### 核心许可：CC BY-NC-SA 4.0

- ✅ **署名**：必须注明原作者
- ❌ **非商业**：不得销售源代码或将其封闭
- 🔄 **相同方式共享**：修改后必须以相同协议发布

### 商业豁免条款（"地摊经济"特别授权）

**对于个人创作者、街边摊贩、小型私营企业**：

你**无需申请许可**，自动获得以下权利：
- 使用本软件生成模型
- 销售实体打印品（钥匙扣、浮雕等）
- 在夜市、市集、线上小店销售

**去摆摊吧，去赚钱！这是你的权利。**

*注：批量工业化生产、SaaS平台化运营、OEM贴牌等场景仍需联系作者商业授权。*

---

Lumina Studio v1.5.4整合三大模块，统一界面：

### 📐 模块1：校准板生成器

生成精密校准板，物理测试耗材混色。

- **多种色彩系统**：
  - **4色（CMYW/RYBW）**：1024色（4种基础耗材×5层）
  - **6色**：1296色（6种基础耗材×3层）- 扩展色域
  - **8色**：2738色（8种基础耗材×2页）- 专业级广色域
  - **黑白模式**：32级灰度，用于单色打印
- **智能校准工作流**：
  - 4色：单板，全排列
  - 6色：单板，扩展调色板
  - 8色：双页系统，带合并功能
- **面朝下优化**：观察面直接接触打印平台，表面光滑
- **实心背板**：自动生成不透明背板，确保色彩一致性和结构强度
- **防重叠几何**：对体素应用0.02mm微缩，防止切片器线宽冲突

### 🎨 模块2：颜色提取器

数字化你打印机的物理现实。

- **计算机视觉**：透视变换+镜头畸变校正自动对齐网格
- **多模式支持**：
  - 4色（CMYW/RYBW）：标准校准
  - 6色：扩展调色板提取
  - 8色：双页提取，支持手动修正
  - 黑白模式：灰度校准
- **模式感知对齐**：角点标记遵循所选模式的正确颜色序列
- **数字孪生**：从打印品提取RGB值，生成.npy LUT文件
- **人工干预**：交互式探针工具，手动验证/修正特定色块读数
- **8色工作流**：提取第1页 → 手动修正 → 提取第2页 → 合并为单个LUT

### 💎 模块3：图像转换器

使用校准数据将图像转换为可打印3D模型。

- **KD树色彩匹配**：将图像像素映射到LUT中的实际可打印颜色
- **实时3D预览**：交互式WebGL预览，显示真实匹配色彩，可旋转/缩放
- **钥匙扣挂孔生成器**：自动添加功能性挂孔
  - 智能颜色检测（匹配附近模型颜色）
  - 可定制尺寸（宽度、长度、孔径）
  - 矩形底座+半圆顶部+空心孔洞几何
  - 2D预览显示挂孔位置
- **结构选项**：双面（钥匙扣）或单面（浮雕）模式
- **智能背景移除**：自动透明度检测，可调容差
- **正确的3MF命名**：对象按颜色命名（如"Cyan"、"Magenta"），而非"geometry_0"，便于切片器识别

---

## v1.5.6 核心更新 🚀

### 6色和8色模式支持

- 🎨 **6色扩展模式** - 1296色（6种基础耗材×3层），更广色域
- 🌈 **8色专业模式** - 2738色（8种基础耗材×2页），最大色彩范围
- 📄 **双页工作流** - 8色模式使用两块校准板，合并为单个LUT
- 🔧 **手动颜色修正** - 点击任意色块手动调整RGB值，合并前修正
- 🎯 **智能角点检测** - 根据所选模式自动识别角点标记颜色
- ⚫ **黑白灰度模式** - 32级灰度校准，用于单色打印

### LUT合并与堆叠信息保留

- 🎨 **合并LUT支持** - 组合多个LUT（8色+6色+4色+黑白）扩展色域
- � **堆叠信息保留** - 合并的LUT保留校准打印的原始堆叠数据
- 🔄 **NPZ格式** - 合并的LUT保存为`.npz`文件，包含颜色和堆叠数组
- 🎯 **智能重建** - 自动重建所有LUT类型（黑白/4色/6色/8色）的堆叠信息
- 🖼️ **颜色替换支持** - 合并的LUT完全兼容颜色替换功能
- 📤 **上传支持** - 所有文件上传组件现在接受`.npy`和`.npz`格式

### 技术改进

- ✅ **多对象3MF导出** - 合并的LUT正确导出每种材料的独立对象
- 🔍 **格式自动检测** - 系统自动检测并加载`.npy`或`.npz`格式
- 🏷️ **视觉指示器** - 合并的LUT在下拉菜单中显示`[Merged]`标签，便于识别
- 🐛 **Bug修复** - 修复8色手动修正持久化问题

---

## v1.5.4 核心更新 🚀

### 矢量模式改进

- 🐛 **布尔运算优化** - 改进矢量模式的颜色重叠处理逻辑
- 🎯 **SVG顺序保持** - 保持SVG原始绘制顺序，确保正确的层叠关系
- ✨ **微Z偏移技术** - 为同材质的不同颜色添加0.001mm微偏移，保持细节独立
- 🛡️ **小特征保护** - 增强对小型几何特征的保护机制

### 版本更新

- ✅ **版本号更新** - 更新至 v1.5.4 以保持一致性

---

## v1.5.0 核心更新 🚀

### 代码标准化

- ✅ **注释统一为英文** - 所有代码注释翻译为英文，提升国际化协作能力
- ✅ **文档规范化** - 统一使用 Google-style docstrings，提升代码可读性
- ✅ **代码清理** - 移除冗余注释，保留关键算法说明

---

## v1.4.1 核心更新 🚀

### 建模模式整合

**高保真模式取代矢量模式和版画模式**：

原有的三种建模模式（矢量/版画/像素）已精简为**两种统一模式**：

| 模式 | 说明 | 适用场景 |
|------|------|---------|
| 🎨 **高保真模式** | 统一的RLE网格生成 + K-Means量化 | 标志、照片、肖像、插画 |
| 🧱 **像素艺术模式** | 传统体素网格，保留方块美学 | 像素艺术、8bit风格图形 |

**为什么要改？**
- 矢量模式和版画模式共享90%的相同代码
- 高保真模式结合了两者的优点：平滑曲线 + 细节保留
- 简化界面，减少令人困惑的选项
- 所有高质量输出统一使用10 px/mm分辨率

### 语言切换功能

- **🌐 动态语言切换**：点击右上角的语言按钮即可在中英文之间切换
- **全界面翻译**：所有界面元素即时更新，无需刷新页面
- **持久化设置**：会话期间保持语言偏好

### 其他改进

- **代码优化**：改进代码结构和可维护性
- **文档更新**：增强内联文档和注释
- **稳定性改进**：修复小问题并优化性能

---

### 之前版本更新（v1.4）

### 三种建模模式

Lumina Studio v1.4引入**三种截然不同的几何生成引擎**，满足从像素艺术到照片级细节的全场景需求：

| 模式 | 适用场景 | 技术特点 | 精度 |
|------|---------|---------|------|
| 🎨 **矢量模式** | 标志、插画、卡通 | 平滑曲线、OpenCV轮廓提取 | 10 px/mm（0.1mm/像素） |
| 🖼️ **版画模式** ⭐ | 照片、肖像、复杂纹理 | SLIC超像素 + 细节保护 | 10 px/mm |
| 🧱 **像素模式** | 像素艺术、8bit风格 | 方块几何、怀旧风格 | 2.4 px/mm（喷嘴宽度） |

### 色彩量化引擎

**"先聚类，后匹配"（Cluster First, Match Second）**：

传统方法逐像素匹配100万个颜色到LUT，v1.4改为：
1. **K-Means聚类**：将图像量化到K种主色（可调8-256，默认64）
2. **只匹配K种颜色**：速度提升1000倍
3. **空间去噪**：双边滤波 + 中值滤波，消除碎片化区域

**用户可控参数**：
- **矢量色彩细节**滑块：8色（极简）到 256色（照片级）

### 其他改进

| 功能 | 说明 |
|------|------|
| 📏 分辨率解耦 | 矢量/版画模式10 px/mm，像素模式2.4 px/mm |
| 🎮 3D预览智能降采样 | 大模型自动简化预览（保持3MF完整质量） |
| 🚫 浏览器崩溃保护 | 检测模型复杂度，超200万像素禁用预览 |

**之前版本更新（v1.2-1.3）**：

| 功能 | 说明 |
|------|------|
| 🔧 修复3MF命名 | 切片器现在显示正确的颜色名称（White、Cyan、Magenta...） |
| 🎨 双色彩模式 | 完整支持CMYW和RYBW色彩系统 |
| 🎮 实时3D预览 | 交互式预览，显示实际LUT匹配的颜色 |
| 🌐 双语界面 | 界面全程中英文标签 |
| 📏 优化间隙 | 默认间隙改为0.82mm，适配标准线宽 |
| 📦 统一应用 | 三大工具合并为单个应用 |

---

## 开发路线图

### 阶段1：基础架构 ✅ 完成

**目标**：像素艺术与照片级图形

- ✅ 固定CMYW/RYBW混色
- ✅ 两种建模模式（高保真/像素艺术）
- ✅ 高保真模式RLE网格生成
- ✅ 超高精度（10 px/mm，0.1mm/像素）
- ✅ K-Means色彩量化架构
- ✅ 实心背板生成
- ✅ 闭环校准系统
- ✅ 实时3D预览，真实色彩
- ✅ 钥匙扣挂孔生成器
- ✅ 动态语言切换（中英文）

### 阶段2：漫画模式（单色） 🚧 进行中

**目标**：漫画面板、墨画、高对比度插图

- 逻辑：基于厚度的灰度黑白分层（类lithophane逻辑）
- 技术：模拟网点（Ben-Day dots）

### 阶段3：动态调色板引擎

**目标**：自适应色彩系统

- 逻辑：动态调色板支持（4/6/8色自动选择）
- 技术：
  - 智能色彩聚类算法
  - 自适应抖动算法
  - 感知色差优化

### 阶段4：扩展色彩模式 ✅ 完成

**目标**：专业多材料打印

- ✅ 6色扩展模式（1296色）
- ✅ 8色专业模式（2738色）
- ✅ 黑白灰度模式（32级）
- 🚧 拼豆（Perler bead）模式（进行中）

---

## 安装

### 克隆仓库

```bash
git clone https://github.com/MOVIBALE/Lumina-Layers.git
cd Lumina-Layers
```

### 选项 1：Docker (推荐)

使用 Docker 是运行 Lumina Studio 最简单的方法，无需担心系统级依赖项（如 `cairo` 或 `pkg-config`）。

1. **构建镜像**：
   ```bash
   docker build -t lumina-layers .
   ```

2. **运行容器**：
   ```bash
   docker run -p 7860:7860 lumina-layers
   ```

3. 在浏览器中打开 `http://localhost:7860`。

### 选项 2：本地安装

**基础依赖**（必需）：
```bash
pip install -r requirements.txt
```

---

## 使用指南

### 快速启动

```bash
python main.py
```

这将在标签页中启动包含所有三个模块的Web界面。

---

### 步骤1：生成校准板

1. 打开**📐 校准板**标签
2. 选择色彩模式：
   - **4色 RYBW**（红/黄/蓝/白）- 传统三原色，1024色
   - **4色 CMYW**（青/品红/黄/白）- 印刷色彩，色域更广，1024色
   - **6色** - 扩展调色板，1296色（需要6耗材打印机）
   - **8色** - 专业模式，2738色（双页工作流）
   - **黑白** - 灰度模式，32级
3. 调整色块大小（默认：5mm）和间隙（默认：0.82mm）
4. 点击**生成**并下载`.3mf`文件
   - 4色/6色/黑白：单个文件
   - 8色：两个文件（第1页和第2页）

**打印设置**：

- 层高：0.08mm（色彩层），背板可用0.2mm
- 耗材槽位必须匹配所选模式

| 模式 | 总颜色数 | 耗材槽位 |
|------|---------|---------|
| 4色 RYBW | 1024 | 白色、红色、黄色、蓝色 |
| 4色 CMYW | 1024 | 白色、青色、品红、黄色 |
| 6色 | 1296 | 白色、青色、品红、黄色、柠檬绿、黑色 |
| 8色 | 2738 | 白色、青色、品红、黄色、柠檬绿、黑色（+2种） |
| 黑白 | 32 | 黑色、白色 |

---

### 步骤2：提取颜色

1. 打印校准板并拍照（面朝上，均匀光照）
2. 打开**🎨 颜色提取器**标签
3. 选择与校准板相同的色彩模式
4. 上传照片
5. 按顺序点击四个角落色块（颜色因模式而异）：

| 模式 | 左上角 | 右上角 | 右下角 | 左下角 |
|------|--------|--------|--------|--------|
| 4色 RYBW | ⬜ 白色 | 红色 | 蓝色 | 黄色 |
| 4色 CMYW | ⬜ 白色 | 青色 | 品红 | 黄色 |
| 6色 | ⬜ 白色 | 青色 | 品红 | 黄色 |
| 8色 | ⬜ 白色 | 黄色 | 黑色 | 青色 |
| 黑白 | ⬜ 白色 | 黑色 | 黑色 | 黑色 |

6. 根据需要调整校正滑块（自动白平衡默认关闭、暗角、畸变）
7. 点击**提取**
8. **仅8色模式**：
   - 提取第1页后，可以点击任意色块手动修正
   - 用相同流程提取第2页
   - 点击**合并8色页面**组合为最终LUT
9. 下载`.npy` LUT文件

---

### 步骤3：转换图像

1. 打开**💎 图像转换器**标签
2. 上传`.npy` LUT文件
3. 上传图像
4. 选择与LUT相同的色彩模式
5. **选择建模模式**：
   - **高保真（平滑）** - 推荐用于标志、照片、肖像、插画
   - **像素艺术（方块）** - 推荐用于像素艺术和8bit风格图形
6. 调整**色彩细节**滑块（8-256色，默认64）：
   - 8-32色：极简风格，快速生成
   - 64-128色：平衡细节与速度（推荐）
   - 128-256色：照片级细节，生成较慢
7. 点击**👁️ 生成预览**查看结果
8. （可选）添加钥匙扣挂孔：
   - 点击2D预览图上希望挂孔连接的位置
   - 勾选"启用挂孔"复选框
   - 调整挂孔宽度、长度和孔径
   - 挂孔颜色将自动从附近像素检测
9. 选择结构类型：
   - **双面** - 用于钥匙扣（两面都有图像）
   - **单面** - 用于浮雕/lithophane风格
10. 点击**🚀 生成3MF**
11. 在交互式3D查看器中预览
12. 下载`.3mf`文件

---

## 技术栈

| 组件 | 技术 |
|------|------|
| 核心逻辑 | Python（NumPy用于体素操作） |
| 几何引擎 | Trimesh（网格生成与导出） |
| UI框架 | Gradio 4.0+ |
| 视觉栈 | OpenCV（透视与颜色提取） |
| 色彩匹配 | SciPy KDTree |
| 3D预览 | Gradio Model3D（GLB格式） |

---

## 工作原理

### 为什么需要校准

理论TD值假设：
- 耗材染料浓度完全一致
- 所有材料喷嘴温度相同
- 层间粘合均匀

实际上，这些因素在以下情况下存在显著差异：
- 不同耗材品牌/批次
- 打印机型号和喷嘴设计
- 环境湿度和温度

基于LUT的方法通过测量实际打印颜色并在RGB空间中通过最近邻搜索匹配来解决这个问题。

---

## 协议

本项目采用**知识共享 署名-非商业性使用-相同方式共享 4.0 国际许可协议**（CC BY-NC-SA 4.0）。

- ✅ **署名**：必须注明原作者
- ❌ **非商业**：不得用于商业目的（源代码层面）
- 🔄 **相同方式共享**：修改后必须以相同协议发布

**商业豁免**：个人创作者、街边摊贩、小型私营企业可自由使用本软件生成模型并销售实体打印品。

---

## 致谢

特别感谢：

- **HueForge** - 在FDM打印中开创光学混色技术
- **AutoForge** - 让多色工作流民主化
- **3D打印社区** - 持续创新

---

Made with ❤️ by [MIN]

⭐ 如果觉得有用，请给个Star！
